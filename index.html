<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Libras ‚Äì Integra√ß√£o Completa</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #e5edf6;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #0f172a;
    }

    .app-container {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 16px 20px;
      background: #e5edf6;
      border-radius: 0;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .chat-config-strip {
      display: flex;
      gap: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 10px;
      padding-top: 10px;
    }

    .config-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .config-group label {
      color: #475569;
    }

    .config-group select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #f8fafc;
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: #475569;
      justify-content: space-between;
    }

    .topbar-group {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #ffffffaa;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      cursor: pointer;
    }

    .topbar-group strong {
      font-weight: 600;
    }

    .topbar-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
    }

    .main-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 2.2fr 1fr;
      gap: 16px;
    }

    @media screen and (max-width: 1024px) {
      .app-container {
        padding: 10px;
        gap: 10px;
      }

      .main-grid {
        grid-template-columns: 1fr; /* Coluna √∫nica */
        grid-template-rows: 1fr auto; /* V√≠deo em cima, chat embaixo */
        gap: 10px;
      }

      .left-panel {
        min-height: 400px; /* Altura m√≠nima para o v√≠deo */
      }

      .right-panel {
        height: auto; /* Altura autom√°tica para o chat */
      }
    }

    .left-panel {
      background: #dde8f4;
      border-radius: 16px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
    }

    .canvas {
      flex: 1;
      background: #ffffff;
      border-radius: 14px;
      border: 3px solid #d4e2f7;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    #video {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
      background: #f1f5f9;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal-content {
      background: white;
      width: 350px;
      padding: 22px;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      gap: 12px;
      transform-origin: center center;
    }

    .modal-content h2 {
      margin: 0 0 4px 0;
    }

    .modal-content label {
      font-size: 13px;
      font-weight: 500;
    }

    .modal-content select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }

    .modal-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      gap: 8px;
    }

    @keyframes popupShow {
      from { opacity: 0; transform: translateY(16px) scale(0.96); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes popupHide {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to   { opacity: 0; transform: translateY(16px) scale(0.96); }
    }

    .modal-content.opening {
      animation: popupShow 0.22s ease-out forwards;
    }

    .modal-content.closing {
      animation: popupHide 0.18s ease-in forwards;
    }

    .image-viewer-content {
      display: flex;
      align-items: center;
      justify-content: center;
      max-width: 90vw;
      max-height: 90vh;
      cursor: pointer;
    }

    .overlay-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      font-size: 11px;
      line-height: 1.4;
      border: 1px solid rgba(148, 163, 184, 0.7);
      backdrop-filter: blur(4px);
      z-index: 40;
      min-width: 150px;
    }

    .overlay-panel div { margin-bottom: 2px; }
    .overlay-panel strong { color: #e5e7eb; }

    .giant-letter {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.6);
      font-size: 140px;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.95);
      text-shadow: 0 0 20px rgba(0,0,0,0.6);
      opacity: 0;
      transition: opacity 0.25s ease, transform 0.25s ease;
      pointer-events: none;
      z-index: 20;
    }

    .countdown-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 200px;
      font-weight: 900;
      color: white;
      z-index: 50;
    }

    .confidence-wrapper {
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      text-align: center;
      z-index: 30;
    }

    #confidenceLabel {
      font-size: 14px;
      font-weight: 600;
      color: white;
      text-shadow: 0 0 6px rgba(0,0,0,0.6);
      margin-bottom: 6px;
    }

    .confidence-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.3);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.4);
    }

    .confidence-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,#ef4444,#f97316,#22c55e,#16a34a);
      transition: width 0.2s ease;
    }

    .history-strip {
      margin-top: 12px;
      display: flex;
      gap: 6px;
      overflow-x: auto;
      height: 40px; /* Altura fixa para evitar o "salto" de tela */
    }

    .history-item {
      min-width: 32px;
      min-height: 32px;
      border-radius: 8px;
      background: #ffffff;
      border: 2px solid #cbd5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 4px 8px rgba(15,23,42,0.16);
    }

    .bottom-strip-wrapper {
      margin-top: 4px;
      border-radius: 18px;
      background: #7fdde0;
      padding: 10px 14px;
      box-shadow: 0 8px 18px rgba(8, 47, 73, 0.25);
    }

    .bottom-strip {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sequence-carousel {
      flex: 1;
      display: flex;
      gap: 10px;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .sequence-card {
      min-width: 60px;
      height: 70px;
      border-radius: 18px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.18);
    }

    .sequence-card.active {
      border: 3px solid #22c55e;
      box-shadow: 0 0 0 3px #22c55e, 0 6px 15px rgba(34, 197, 94, 0.4);
      transform: scale(1.1);
      transition: all 0.2s ease-out;
    }

    .sequence-card img {
      max-width: 80%;
      max-height: 80%;
    }

    .sequence-card.active img {
      max-width: 90%;
      max-height: 90%;
    }

    .right-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.18);
      height: 100%;
      overflow: hidden;
    }

    .status-panel {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items: flex-start;
      padding: 10px 0;
      border-top: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      margin: 10px 0 10px 0;
    }

    .status-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 18px;
      color: #475569;
    }

    .status-group:nth-child(1) {
      align-self: center;
    }

    .status-group:nth-child(2) {
      align-self: center;
    }

    .status-group-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 8px;
    }

    .status-item {
      white-space: nowrap;
    }

    .hold-info {
      font-size: 12px;
      color: #475569;
      text-align: center;
    }

    #timerBarWrapper {
      width: 100%;
      height: 6px;
      background: #d1d5db;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 4px;
    }

    #timerBar {
      height: 100%;
      width: 0%;
      background: #0ea5e9;
      transition: width 0.2s;
    }

    .feedback-wait {
      font-weight: 600;
      color: #0ea5e9;
    }

    #chatMessages {
      flex: 1 1 auto; /* Permite que o chat cres√ßa e encolha */
      max-height: 550px;
      min-height: 150px; /* Altura m√≠nima menor para telas pequenas */
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      padding-right: 4px;
      margin-bottom: 10px;
    }

    #chatMessages::-webkit-scrollbar {
      width: 6px;
    }

    #chatMessages::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }

    #chatMessages::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    #chatMessages::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .bubble {
      max-width: 80%;
      padding: 8px 14px;
      border-radius: 18px;
      font-size: 12px;
      box-shadow: 0 4px 10px rgba(15,23,42,0.16);
      word-break: break-word;
    }

    .bubble-assistant {
      background: #22c5c7;
      color: white;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .bubble-user {
      background: #e5e7eb;
      color: #111827;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }

    #message {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 8px 12px;
    }

    .btn-send-chat {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #22c5c7;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .btn-send-chat:hover {
      background: #1eafb1;
    }

    .btn-primary {
      background: #22c5c7;
      border-radius: 999px;
      padding: 8px 14px;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
    }

    .btn-secondary {
      background: #0ea5e9;
      color: white;
      border-radius: 999px;
      padding: 6px 10px;
      border: none;
      font-size: 12px;
      white-space: nowrap;
      cursor: pointer;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      border-radius: 999px;
      padding: 6px 10px;
      border: none;
      font-size: 12px;
      white-space: nowrap;
      cursor: pointer;
    }

    .letter-badge-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .letter-badge {
      width: 75px;
      height: 75px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 34px;
      font-weight: 900;
      transition: all 0.25s ease;
      background: #e5f3ff;
      border: 3px solid #bfdbfe;
      color: #0f172a;
      box-shadow: 0 8px 18px rgba(15,23,42,0.18);
    }

    .letter-badge.correct {
      background: #dcfce7;
      border-color: #22c55e;
    }

    .letter-badge.wrong {
      background: #fee2e2;
      border-color: #ef4444;
    }

    .letter-badge.neutral {
      background: #e5f3ff;
      border-color: #bfdbfe;
    }

    .toggle-switch-container {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 500;
      color: #475569;
    }

    .toggle-switch-label {
      font-weight: 600;
      color: #0f172a;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #22c5c7;
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #22c5c7;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .slider.round {
      border-radius: 34px;
    }

    .slider.round:before {
      border-radius: 50%;
    }
  </style>
</head>

<body>
<div class="app-container">

  <!-- TOPO -->
  <header class="topbar">
    <div class="topbar-group" id="openConfigBtn">
      <strong>‚öôÔ∏è Configura√ß√µes</strong>
    </div>

    
    <div class="topbar-actions">
      <button id="btnStartCombined" class="btn-secondary" disabled>Iniciar</button>
      <button id="btnStopCombined" class="btn-danger" disabled>Parar</button>
    </div>
  </header>

  <!-- SELECT C√ÇMERA HIDDEN -->
  <select id="cameraSelect" style="display:none"></select>

  <!-- GRID -->
  <main class="main-grid">

    <!-- ESQUERDA -->
    <section class="left-panel">

      <div class="canvas">
        <!-- v√≠deo local da c√¢mera -->
        <video id="video" autoplay muted playsinline></video>
        <!-- canvas escondido para capturar frames -->
        <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

        <div class="overlay-panel">
          <div id="overlayTarget"><strong>Alvo:</strong> -</div>
          <div id="overlayDetected"><strong>Detectada:</strong> -</div>
          <div id="overlayPrecision"><strong>Precis√£o:</strong> -</div>
        </div>

        <div id="giantLetter" class="giant-letter">-</div>
        <div id="countdownOverlay" class="countdown-overlay"></div>

        <div class="confidence-wrapper">
          <div id="confidenceLabel">Precis√£o: -</div>
          <div class="confidence-bar">
            <div id="confidenceFill" class="confidence-fill"></div>
          </div>
        </div>
      </div>

      <div class="bottom-strip-wrapper">
        <div class="bottom-strip">
          <div id="sequenceCarousel" class="sequence-carousel">
            <span class="sequence-empty">Sua sequ√™ncia de gestos aparecer√° aqui.</span>
          </div>
          <div class="strip-more">‚Ä¶</div>
        </div>
      </div>

      <div id="letterHistory" class="history-strip"></div>

    </section>

    <!-- DIREITA -->
    <aside class="right-panel">
      <div class="chat-card">

        <div id="statusBubble" style="display:none;"></div>

        <div class="status-panel">
          <div class="status-group">
            <div id="captureStatus" class="status-item">C√¢mera: parado</div>
            <div id="feedbackText" class="feedback-wait status-item">Aguardando sequ√™ncia...</div>
          </div>

          <div class="status-group">
            <div id="targetWord" class="status-item">Palavra alvo: -</div>
            <div id="targetLetter" class="status-item">Letra alvo: -</div>
            <div id="currentLetter" class="status-item">Letra detectada: -</div>
          </div>

          <div class="status-group status-group-center">
            <div class="letter-badge-wrapper">
              <div class="letter-badge-label">Letra detectada</div>
              <div id="letterBadge" class="letter-badge neutral">-</div>
            </div>

            <div class="hold-info">
              Hold: <span id="timerText">-</span>
              <div id="timerBarWrapper"><div id="timerBar"></div></div>
            </div>
          </div>
        </div>

        <!-- Configura√ß√µes de Linguagem e Tipo removidas. Valores fixos: pt-br e letter. -->

        <div id="chatMessages"></div>

        <div class="input-row">
          <input id="message" placeholder="Digite o que deseja aprender">
          <button id="btnTranslate" class="btn-send-chat">
            <img src="https://cdn-icons-png.flaticon.com/128/9333/9333991.png" alt="Enviar" style="width: 18px; height: 18px; filter: invert(100%);">
          </button>
        </div>

      </div>
    </aside>

  </main>
</div>

<!-- IMAGE VIEWER MODAL -->
<div id="imageViewerModal" class="modal-overlay" style="display: none;">
  <div id="imageViewerContent" class="image-viewer-content">
    <img id="expandedImage" src="" alt="Imagem expandida" style="max-width: 90vw; max-height: 90vh; object-fit: contain;">
  </div>
</div>

<!-- POPUP CONFIG -->
<div id="configModal" class="modal-overlay">
  <div id="configModalContent" class="modal-content">
    <h2>Configura√ß√µes</h2>

    <label>C√¢mera:</label>
    <select id="cfg_cameraSelect"></select>

    <div class="modal-buttons">
      <button id="saveConfig" class="btn-primary">Salvar</button>
      <button id="closeConfig" class="btn-danger">Fechar</button>
    </div>
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);

  // URLs dos servi√ßos
  const integrationBase = () => "http://35.238.147.131:9090/api/v1/integration";
  const modelBase = () => "http://136.112.123.207:8001";

  let progressInterval = null;
  let lastLetter = null;
  let sessionCompleted = false;
  let hasSequence = false;
  let sendingFrames = false;
  let videoStream = null;

  const sequenceCarousel   = $("sequenceCarousel");
  const overlayDetected    = $("overlayDetected");
  const overlayTarget      = $("overlayTarget");
  const overlayPrecision   = $("overlayPrecision");
  const giantLetter        = $("giantLetter");
  const confidenceFill     = $("confidenceFill");
  const confidenceLabel    = $("confidenceLabel");
  const letterBadge        = $("letterBadge");
  const videoEl            = $("video");
  const canvasEl           = $("canvas");
  const ctx                = canvasEl.getContext("2d");

  const getLanguage   = () => "pt-br"; // Valor fixo conforme solicita√ß√£o
  let currentType     = "letter"; // Valor fixo conforme solicita√ß√£o
  const getType       = () => currentType;
  const getCameraId   = () => $("cameraSelect").value || null;

  // Campo de Linguagem removido. Valor fixo: pt-br.

  function addChatMessage(text, sender = "assistant") {
    const container = $("chatMessages");
    const bubble = document.createElement("div");
    bubble.className = "bubble " + (sender === "user" ? "bubble-user" : "bubble-assistant");
    bubble.textContent = text;
    container.appendChild(bubble);

    // L√≥gica para limitar o n√∫mero de mensagens a 20
    const maxMessages = 20;
    while (container.children.length > maxMessages) {
      // Remove o primeiro filho (a mensagem mais antiga)
      container.removeChild(container.firstChild);
    }

    // Usar setTimeout para garantir que a rolagem ocorra ap√≥s a renderiza√ß√£o
    setTimeout(() => {
      container.scrollTop = container.scrollHeight;
    }, 0);
  }

  addChatMessage("Ol√°, sou Yasmin. Vamos praticar Libras! üí¨", "assistant");
  addChatMessage("Digite uma frase e clique em ‚ñ∂Ô∏è para gerar a sequ√™ncia.", "assistant");

  // O tipo agora √© fixo como 'letter' (soletrar).
  // currentType j√° est√° definido como 'letter' na linha 835.
  addChatMessage("Configura√ß√µes de Linguagem (pt-br) e Tipo (Soletrar) fixas.", "assistant");

  // Carregar c√¢meras (salvando deviceId)
  async function loadCameras() {
    try {
      await navigator.mediaDevices.getUserMedia({ video: true });
      const devices = await navigator.mediaDevices.enumerateDevices();

      const cams = devices.filter(d => d.kind === "videoinput");

      const selPopup  = $("cfg_cameraSelect");
      const selHidden = $("cameraSelect");

      selPopup.innerHTML = "";
      selHidden.innerHTML = "";

      if (cams.length === 0) {
        selPopup.innerHTML = "<option>Nenhuma c√¢mera encontrada</option>";
        selHidden.innerHTML = "<option value=''>none</option>";
        return;
      }

      cams.forEach(cam => {
        const name = cam.label || `C√¢mera`;

        const opt1 = document.createElement("option");
        opt1.value = cam.deviceId;
        opt1.textContent = name;
        selPopup.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = cam.deviceId;
        opt2.textContent = name;
        selHidden.appendChild(opt2);
      });

      selPopup.value = selHidden.value;
    } catch (err) {
      console.error("Erro ao carregar c√¢meras:", err);
      alert("Erro ao acessar c√¢mera. Veja o console.");
    }
  }

  loadCameras();

  // Fun√ß√£o que executa a tradu√ß√£o/gera√ß√£o de sequ√™ncia
  async function translateMessage() {
    const text = $("message").value.trim();
    if (!text) return;

    const btnTranslate = $("btnTranslate");
    btnTranslate.disabled = true; // Desabilita o bot√£o

    addChatMessage(text, "user");



    const payload = {
      language: getLanguage(),
      type: getType(),
      message: text
    };

    $("statusBubble").textContent = "Gerando sequ√™ncia...";
    addChatMessage(`Gerando sequ√™ncia para: "${text}"‚Ä¶`, "assistant");
    sequenceCarousel.innerHTML = '<span class="sequence-empty">Gerando...</span>';
    hasSequence = false;
    $("btnStartCombined").disabled = true;

    try {
      const resp = await fetch(`${integrationBase()}/translate`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const txt = await resp.text();
        console.error("Erro no /translate:", resp.status, txt);
        alert("Erro ao gerar sequ√™ncia (backend). Veja o console.");
        return;
      }

      const data = await resp.json();
      renderSequence(data.words);

      $("statusBubble").textContent = "Sequ√™ncia pronta! Agora inicie a sess√£o.";
      addChatMessage("Sequ√™ncia pronta! Agora clique em \"Iniciar\" para come√ßar a praticar. ‚úã", "assistant");

      hasSequence = true;
      $("btnStartCombined").disabled = false;
      $("feedbackText").textContent = "Pronto para iniciar sess√£o.";
    } catch (err) {
      console.error("Erro de rede em /translate:", err);
      alert("Erro ao gerar sequ√™ncia: " + err.message);
    } finally {
      $("btnTranslate").disabled = false; // Reabilita o bot√£o
    }
  }

  // TRADU√á√ÉO (gera sequ√™ncia via integration/translate)
  $("btnTranslate").onclick = translateMessage;

  // Enviar mensagem ao pressionar Enter
  $("message").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      event.preventDefault(); // Previne a quebra de linha no input
      translateMessage();
    }
  });

  function renderSequence(words) {
    sequenceCarousel.innerHTML = "";

    if (!words || words.length === 0) {
      sequenceCarousel.innerHTML =
        '<span class="sequence-empty">Nenhuma sequ√™ncia.</span>';
      return;
    }

    let isFirstCard = true;
    words.forEach(word => {
      word.letters.forEach(letter => {
        const card = document.createElement("div");
        card.className = "sequence-card";
        card.dataset.letter = letter.char || letter.letter || ""; // compat

        if (isFirstCard) {
          card.classList.add("active");
          isFirstCard = false;
        }

        const img = document.createElement("img");
        img.src = `data:${letter.mediaType};base64,${letter.data}`;
        img.onclick = () => openImageViewer(img.src);
        card.appendChild(img);

        sequenceCarousel.appendChild(card);
      });
    });
  }

  // -------- C√ÇMERA LOCAL + ENVIO DE FRAMES PARA /vision/predict-frame --------

  async function startCamera() {
    try {
      const cameraId = getCameraId();
      const constraints = cameraId
        ? { video: { deviceId: { exact: cameraId } } }
        : { video: true };

      videoStream = await navigator.mediaDevices.getUserMedia(constraints);
      videoEl.srcObject = videoStream;
      $("captureStatus").textContent = "C√¢mera: capturando...";
      sendingFrames = true;
      frameLoop();
      addChatMessage("C√¢mera iniciada. üëÄ", "assistant");
    } catch (err) {
      console.error("Erro ao iniciar c√¢mera:", err);
      $("captureStatus").textContent = "C√¢mera: erro";
      addChatMessage("Erro ao iniciar c√¢mera. Verifique permiss√µes.", "assistant");
      throw err;
    }
  }

  function stopCamera() {
    sendingFrames = false;
    if (videoStream) {
      videoStream.getTracks().forEach(t => t.stop());
      videoStream = null;
    }
    videoEl.srcObject = null;
    $("captureStatus").textContent = "C√¢mera: parado";
    addChatMessage("Parei a captura da c√¢mera.", "assistant");
  }

  function frameLoop() {
    if (!sendingFrames || !videoEl.srcObject) return;

    const w = canvasEl.width;
    const h = canvasEl.height;
    ctx.drawImage(videoEl, 0, 0, w, h);

    canvasEl.toBlob(async (blob) => {
      if (blob && sendingFrames) {
        const formData = new FormData();
        formData.append("file", blob, "frame.jpg");

        try {
          // Chamando diretamente o model-service para atualizar a sess√£o
          await fetch(`${modelBase()}/vision/predict-frame?language=${getLanguage()}`, {
            method: "POST",
            body: formData
          });
          // A resposta n√£o √© estritamente necess√°ria aqui,
          // pois o /session/progress l√™ o estado interno atualizado.
        } catch (err) {
          console.error("Erro ao enviar frame:", err);
        }
      }

      if (sendingFrames) {
        setTimeout(frameLoop, 120); // ~8 FPS
      }
    }, "image/jpeg", 0.8);
  }

  // -------- SESS√ÉO (INTEGRATION / SESSION CONTROLLER) --------

  async function startSession() {
    const text = $("message").value.trim();
    if (!text) {
      alert("Digite uma frase antes de iniciar a sess√£o.");
      return;
    }

    const payload = {
      language: getLanguage(),
      type: getType(),
      message: text
    };

    try {
      const resp = await fetch(`${integrationBase()}/session/start`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const txt = await resp.text();
        console.error("Erro no /session/start:", resp.status, txt);
        alert("Erro ao iniciar sess√£o (backend). Veja o console.");
        return;
      }

      const data = await resp.json();
      console.log("Sess√£o iniciada:", data);

      addChatMessage("Sess√£o iniciada! Fa√ßa o gesto da letra que aparecer no quadro. ‚úã", "assistant");
      startPolling();
    } catch (err) {
      console.error("Erro de rede em /session/start:", err);
      alert("Erro ao iniciar sess√£o: " + err.message);
    }
  }

  async function stopSession() {
    stopPolling();

    try {
      await fetch(`${integrationBase()}/session/stop?language=${getLanguage()}`, {
        method: "POST"
      });
    } catch (err) {
      console.error("Erro em /session/stop:", err);
    }

    addChatMessage("Sess√£o finalizada. Quando quiser, gere outra sequ√™ncia para continuar praticando. üòÑ", "assistant");
  }

  // BOT√ÉO INICIAR (combined)
  $("btnStartCombined").onclick = async () => {
    if (!hasSequence) {
      alert("Gere uma sequ√™ncia primeiro (use o ‚ñ∂Ô∏è).");
      return;
    }

    sessionCompleted = false;
    $("btnStartCombined").disabled = true;
    $("btnStopCombined").disabled = true;

    try {
      await startCamera();
    } catch {
      $("btnStartCombined").disabled = false;
      $("feedbackText").textContent = "Erro ao iniciar c√¢mera.";
      return;
    }

    const countdownOverlay = $("countdownOverlay");
    countdownOverlay.style.display = "flex";
    let count = 5;
    countdownOverlay.textContent = count;

    const countdownInterval = setInterval(() => {
      count--;
      countdownOverlay.textContent = count;

      if (count <= 0) {
        clearInterval(countdownInterval);
        countdownOverlay.style.display = "none";
        countdownOverlay.textContent = "";

        startSession();
        $("btnStopCombined").disabled = false;
        $("feedbackText").textContent = "Sess√£o em andamento...";
      }
    }, 1000);
  };

  // BOT√ÉO PARAR
  $("btnStopCombined").onclick = async () => {
    $("btnStopCombined").disabled = true;
    $("btnStartCombined").disabled = false;

    await stopSession();
    stopCamera();

    sessionCompleted = false;
    $("feedbackText").textContent = "Sess√£o finalizada.";
  };

  // POLLING DE PROGRESSO
  function startPolling() {
    if (progressInterval) return;

    progressInterval = setInterval(async () => {
      try {
        const resp = await fetch(
          `${integrationBase()}/session/progress?language=${getLanguage()}`
        );

        if (!resp.ok) {
          const txt = await resp.text();
          console.error("Erro em /session/progress:", resp.status, txt);
          return;
        }

        const data = await resp.json();

        if (data.status === "completed") {
          stopPolling();

          try {
            await fetch(`${integrationBase()}/session/stop?language=${getLanguage()}`, {
              method: "POST"
            });
          } catch (err) {
            console.error("Erro ao finalizar sess√£o ap√≥s completed:", err);
          }

          sessionCompleted = true;
          $("btnStopCombined").disabled = true;
          $("btnStartCombined").disabled = false;

          $("feedbackText").textContent = "üéâ Parab√©ns! Voc√™ terminou toda a sequ√™ncia!";
          $("feedbackText").className = "feedback-success";

          addChatMessage("üéâ Parab√©ns! Voc√™ terminou toda a sequ√™ncia! Quer tentar outra frase?", "assistant");

          giantLetter.style.opacity = 1;
          giantLetter.textContent = "üëç";
          giantLetter.style.transform = "translate(-50%, -50%) scale(1.1)";
          setTimeout(() => {
            giantLetter.style.transform = "translate(-50%, -50%) scale(0.6)";
          }, 600);

          $("targetWord").textContent   = "Palavra alvo: -";
          $("targetLetter").textContent = "Letra alvo: -";
          $("currentLetter").textContent = "Letra detectada: -";

          document.querySelectorAll(".sequence-card").forEach(card => card.classList.remove("active"));

          $("timerText").textContent = "-";
          $("timerBar").style.width = "0%";

          letterBadge.textContent = "-";
          letterBadge.classList.remove("correct", "wrong");
          letterBadge.classList.add("neutral");

          confidenceLabel.textContent   = `Precis√£o: -`;
          overlayPrecision.textContent  = `Precis√£o: -`;
          confidenceFill.style.width    = `0%`;

          stopCamera();
          return;
        }

        const detected = data.lastPredictedLabel ?? "-";
        const target   = data.currentLetter ?? "-";

        $("currentLetter").textContent = "Letra detectada: " + detected;
        $("targetLetter").textContent  = "Letra alvo: " + target;

        overlayDetected.textContent = `Detectada: ${detected}`;
        overlayTarget.textContent   = `Alvo: ${target}`;

        const allCards = document.querySelectorAll(".sequence-card");
        allCards.forEach(card => card.classList.remove("active"));

        if (target !== "-") {
          const activeCard = document.querySelector(`.sequence-card[data-letter="${target}"]`);
          if (activeCard) {
            activeCard.classList.add("active");
            activeCard.scrollIntoView({ behavior: "smooth", inline: "center" });
          }
        }

        giantLetter.style.opacity = 1;
        giantLetter.textContent = detected;

        letterBadge.textContent = detected;
        letterBadge.classList.remove("correct", "wrong", "neutral");

        if (data.isCorrect === true)      letterBadge.classList.add("correct");
        else if (data.isCorrect === false) letterBadge.classList.add("wrong");
        else                               letterBadge.classList.add("neutral");

        if (detected !== lastLetter && detected !== "-") {
          const item = document.createElement("div");
          item.className = "history-item";
          item.textContent = detected;
          const historyContainer = $("letterHistory");
          historyContainer.appendChild(item);

          // L√≥gica para limitar o n√∫mero de elementos a 20
          const maxHistoryItems = 20;
          while (historyContainer.children.length > maxHistoryItems) {
            // Remove o primeiro filho (o elemento mais antigo)
            historyContainer.removeChild(historyContainer.firstChild);
          }
        }

        lastLetter = detected;

        let conf = data.lastPredictedConfidence ?? 0;
        if (conf <= 1) conf = conf * 100;
        conf = Math.max(0, Math.min(100, conf));

        confidenceLabel.textContent  = `Precis√£o (${detected}): ${conf.toFixed(0)}%`;
        overlayPrecision.textContent = `Precis√£o: ${conf.toFixed(0)}%`;
        confidenceFill.style.width   = `${conf}%`;

        if (conf < 40)      confidenceFill.style.background = "#ef4444";
        else if (conf < 70) confidenceFill.style.background = "#f59e0b";
        else                confidenceFill.style.background = "#22c55e";

        const reqHold = data.requiredHoldTime || 0;
        const curHold = data.currentHoldTime   || 0;

        $("timerText").textContent =
          reqHold > 0 ? `${curHold.toFixed(2)}s / ${reqHold.toFixed(2)}s` : "-";

        $("timerBar").style.width =
          reqHold > 0 ? `${(curHold / reqHold) * 100}%` : "0%";
      } catch (err) {
        console.error("Erro de rede em /session/progress:", err);
      }
    }, 350);
  }

  function stopPolling() {
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
  }

  // CONFIG POPUP
  const modal = $("configModal");
  const modalContent = $("configModalContent");

  $("openConfigBtn").onclick = async () => {
    await loadCameras();
    $("cfg_cameraSelect").value = $("cameraSelect").value;
    modal.style.display = "flex";
    modalContent.classList.remove("closing");
    modalContent.classList.add("opening");
  };

  $("closeConfig").onclick = () => closeModal();

  function closeModal() {
    modalContent.classList.remove("opening");
    modalContent.classList.add("closing");

    setTimeout(() => {
      modal.style.display = "none";
    }, 180);
  }

  $("saveConfig").onclick = () => {
    $("cameraSelect").value = $("cfg_cameraSelect").value;
    closeModal();
    $("statusBubble").textContent = "Configura√ß√µes atualizadas.";
    addChatMessage("Configura√ß√µes atualizadas. ‚úÖ", "assistant");
  };

  // IMAGE VIEWER
  const imageViewerModal = $("imageViewerModal");
  const expandedImage = $("expandedImage");

  function openImageViewer(src) {
    expandedImage.src = src;
    imageViewerModal.style.display = "flex";
  }

  imageViewerModal.onclick = () => {
    imageViewerModal.style.display = "none";
    expandedImage.src = "";
  };

  modal.addEventListener("click", e => {
    if (e.target === modal) {
      closeModal();
    }
  });
</script>
</body>
</html>
